\input{fontspec-testsetup.tex}
\usepackage{fontspec}
\begin{document}
\makeatletter

\setmainfont{texgyretermes-regular.otf}

\begin{fstest}
\setmainfont{texgyretermes-regular.otf}
\noindent set main font\\
\addfontfeatures{Color = AA00AA}
after AFF\\ \normalfont after `normalfont'\\

\setmainfont{texgyretermes-regular.otf}
\noindent set main font\\
\begingroup
\addfontfeatures{Color = AA00AA}
AFF in group\\
\endgroup
after group\\
\end{fstest}


\begin{fstest}
\setmainfont{texgyretermes-regular.otf}
\noindent set main font\\
\addfontfeatures{Color=AA00AA,NFSSFamily=\f@family}
after AFF\\ \normalfont after `normalfont' (should now match)\\

\setmainfont{texgyretermes-regular.otf}
\noindent set main font (why coloured?!)\\
\begingroup
\addfontfeatures{Color=AA00AA,NFSSFamily=\f@family}
AFF in group\\
\endgroup
after group\\
\end{fstest}

\end{document}
