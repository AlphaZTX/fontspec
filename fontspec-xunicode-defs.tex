\ProvidesExplFile{fontspec-xunicode-defs.tex}{2015/10/01}{v0.1}{fontspec-xunicode definitions}

% Use \DeclareUTFcharacter to assign a cs-name to
% access a Unicode code-point...
\newcommand{\DeclareUTFcharacter}[3][\UTFencname]
  {
    \check@hexcom@digits@{#1}{#2}{#3}
  }

% Use \DeclareUTFcomposite to assign a cs-name to access
% accents or composite characters via Unicode code-points,
% or the Unicode "Composing Character" mechanism ...
\newcommand{\DeclareUTFcomposite}[4][\UTFencname]
  {
    \cs_set:cpn
      { \cs_to_str:N #1 \string #3 - \string #4 }
      { \char #2 \relax }
  }
  
\newcommand{\DeclareEncodedCompositeCharacter}[4]
  %  #1 = encoding
  %  #2 = accent-macro in TeX
  %  #3 = position of combining glyph in Unicode
  %  #4 = bare accent position, in Unicode
  %  ##1 = slot for the accented letter
  {
    \expandafter\def\expandafter\next@ii\expandafter{
     \expandafter\expandafter\expandafter\@text@composite\expandafter
      \csname #1\string#2\endcsname####1\@empty
       \@text@composite{\add@UTF@accent{#3}{####1}{#4}}}
    \expandafter\def\expandafter\next@i\expandafter{\expandafter\expandafter
     \expandafter\def\expandafter\csname #1\string#2\endcsname####1}
    \expandafter\next@i\expandafter{\next@ii}
  }

\newcommand{\DeclareEncodedCompositeAccents}[4]
  {
    \expandafter\def\expandafter\next@ii\expandafter{
     \expandafter\expandafter\expandafter\@text@composite\expandafter
      \csname #1\string#2\endcsname####1\@empty
       \@text@composite{\add@UTF@accents{#4}{####1}{#3}}}
    \expandafter\def\expandafter\next@i\expandafter{\expandafter\expandafter
     \expandafter\def\expandafter\csname #1\string#2\endcsname####1}
    \expandafter\next@i\expandafter{\next@ii}
  }

% indirect conditionals, to avoid unbalance when reloaded
\def\UTF@ignore#1{\csname iffalse\endcsname}
\def\UTF@doit#1{\csname iftrue\endcsname}


\def\check@hexcom@digits@#1#2#3
  {
     \ifcat \active\noexpand#3

       \expandafter\def\csname\UTFencname\string#3\endcsname{\char#2\relax}
       \ifx\unDeFiNed@#3
        \ifx\cf@encoding\UTFencname
         \DeclareTextCommand{#3}{OT1}{\undefined}
        \else
         \DeclareTextCommand{#3}{\cf@encoding}{\undefined}
        \fi
       \else {% macro #3 exists already ...
         \let\protect\noexpand
         \edef\UTF@testi{#3}\def\UTF@testii{#3}%
         \ifx\UTF@testi\UTF@testii\aftergroup\UTF@ignore
         \else\aftergroup\UTF@doit\fi
        }%
        \iffalse
         % ... but when it isn't robust, make it so
         \expandafter\let\csname?-\string#3\endcsname#3\relax
         \edef\next@UTF@{{\cf@encoding}%
           {\expandafter\noexpand\csname?-\string#3\endcsname}}%
         \expandafter\DeclareTextCommand\expandafter
            {\expandafter#3\expandafter}\next@UTF@
        \fi
       \fi
          \fi
        }
      
     \else % not active catcode --- shouldn't happen
       % WSPR: actually happens once!!

       \edef\tmp@name{\expandafter\string\csname\UTFencname\endcsname
         \expandafter\string\csname#3\endcsname}%
       \expandafter\def\csname\tmp@name\endcsname{\char#2\relax}%
       \ifx\cf@encoding\UTFencname
        \expandafter\DeclareTextCommand\expandafter
          {\csname#3\endcsname}{OT1}{\undefined}%
       \else
        \expandafter\DeclareTextCommand\expandafter
          {\csname#3\endcsname}{\cf@encoding}{\undefined}%
       \fi

     \fi % end of \ifcat     
  }

\cs_set:Npn \add@UTF@accent  #1#2#3 { #2 \char "#1 \relax }
\cs_set:Npn \add@UTF@accents #1#2#3 { #2 \char "#1 \char "#3 \relax}


% bring \textsuperscript and \textsubscript into the fold of macros 
% dependent on encoding
\let\realLaTeXsuperscript\textsuperscript
\let\realLaTeXsubscript\textsubscript
\DeclareTextAccent{\textsuperscript}{OT1}{999}
\expandafter\expandafter\expandafter\let\expandafter
 \csname?\string\textsuperscript\endcsname\realLaTeXsuperscript
\DeclareTextAccent{\textsubscript}{OT1}{999}
\expandafter\expandafter\expandafter\let\expandafter
 \csname?\string\textsubscript\endcsname\realLaTeXsubscript
\let\super\textsuperscript

\endinput
