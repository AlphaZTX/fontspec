\ProvidesExplFile{fontspec-xunicode-defs.tex}{2015/10/01}{v0.1}{fontspec-xunicode definitions}

% Use \DeclareUTFcharacter to assign a cs-name to
% access a Unicode code-point...
\newcommand{\DeclareUTFcharacter}[3][\UTFencname]
  {
    \let\add@flag\@ne % ==> add support in this encoding
    \check@hexcom@digits@{#1}{#2}{#3}
  }

% Use \DeclareUTFcomposite to assign a cs-name to access
% accents or composite characters via Unicode code-points,
% or the Unicode "Composing Character" mechanism ...
\newcommand{\DeclareUTFcomposite}[4][\UTFencname]
  {{
    \let\add@flag\@ne % ==> add support in this encoding
    \check@hex@digits@{#1}{#2}{#3}{#4}
  }}

\newcommand{\DeclareUTFmulticomposite}[4][\UTFencname]
  {{
    \let\add@flag\@ne % ==> add support in this encoding
    \check@hex@digits@{#1}{#2}{#3}{#4}
  }}

\newcommand{\DeclareEncodedCompositeCharacter}[4]
  %  #1 = encoding
  %  #2 = accent-macro in TeX
  %  #3 = position of combining glyph in Unicode
  %  #4 = bare accent position, in Unicode
  %  ##1 = slot for the accented letter
  {
    \expandafter\def\expandafter\next@ii\expandafter{
     \expandafter\expandafter\expandafter\@text@composite\expandafter
      \csname #1\string#2\endcsname####1\@empty
       \@text@composite{\add@UTF@accent{#3}{####1}{#4}}}
    \expandafter\def\expandafter\next@i\expandafter{\expandafter\expandafter
     \expandafter\def\expandafter\csname #1\string#2\endcsname####1}
    \expandafter\next@i\expandafter{\next@ii}
  }

\newcommand{\DeclareEncodedCompositeAccents}[4]
  {
    \expandafter\def\expandafter\next@ii\expandafter{
     \expandafter\expandafter\expandafter\@text@composite\expandafter
      \csname #1\string#2\endcsname####1\@empty
       \@text@composite{\add@UTF@accent{#4}{####1}{#3}}}
    \expandafter\def\expandafter\next@i\expandafter{\expandafter\expandafter
     \expandafter\def\expandafter\csname #1\string#2\endcsname####1}
    \expandafter\next@i\expandafter{\next@ii}
  }

% indirect conditionals, to avoid unbalance when reloaded
\def\UTF@ignore#1{\csname iffalse\endcsname}
\def\UTF@doit#1{\csname iftrue\endcsname}


\def\check@hexcom@digits@#1#2#3
  {
     \ifcat \active\noexpand#3
      \ifx\add@flag\@ne 
       \expandafter\def\csname\UTFencname\string#3\endcsname{\char#2\relax}
       \ifx\unDeFiNed@#3
        \ifx\cf@encoding\UTFencname
         \DeclareTextCommand{#3}{OT1}{\undefined}
        \else
         \DeclareTextCommand{#3}{\cf@encoding}{\undefined}
        \fi
       \else {% macro #3 exists already ...
         \let\protect\noexpand
         \edef\UTF@testi{#3}\def\UTF@testii{#3}%
         \ifx\UTF@testi\UTF@testii\aftergroup\UTF@ignore
         \else\aftergroup\UTF@doit\fi
        }%
        \iffalse
         % ... but when it isn't robust, make it so
         \expandafter\let\csname?-\string#3\endcsname#3\relax
         \edef\next@UTF@{{\cf@encoding}%
           {\expandafter\noexpand\csname?-\string#3\endcsname}}%
         \expandafter\DeclareTextCommand\expandafter
            {\expandafter#3\expandafter}\next@UTF@
        \fi
       \fi
      \else % \add@flag \z@
       \expandafter\global\expandafter
         \let\csname\UTFencname\string#3\endcsname\relax
      \fi % end of \add@flag switch
      
     \else % not active catcode --- shouldn't happen
      \ifx\add@flag\@ne %
       \edef\tmp@name{\expandafter\string\csname\UTFencname\endcsname
         \expandafter\string\csname#3\endcsname}%
       \expandafter\def\csname\tmp@name\endcsname{\char#2\relax}%
       \ifx\cf@encoding\UTFencname
        \expandafter\DeclareTextCommand\expandafter
          {\csname#3\endcsname}{OT1}{\undefined}%
       \else
        \expandafter\DeclareTextCommand\expandafter
          {\csname#3\endcsname}{\cf@encoding}{\undefined}%
       \fi
      \else % \add@flag \z@
       \expandafter\global\expandafter\let\csname#3\endcsname\relax
      \fi % end of \add@flag switch
     \fi % end of \ifcat     
  }

\def \check@hex@digits@ #1#2#3#4
  {
     \def\UTFchar{\char#2\relax}%
     \expandafter\expandafter\expandafter\declare@utf@composite
     \expandafter\expandafter\expandafter
      {\expandafter\csname#1\endcsname}{\UTFchar}{#3}{#4}\relax
  }

\def \add@UTF@accent #1 #2 #3
  {
    \tl_if_empty:nTF {#2}
      { \char"#3\relax }
      {
        \ifx\ #2\relax
          \char"#3\relax
        \else
          \expandafter\ifx \c_space_tl #2\relax
            \char"#3\relax
          \else
            \ifx \c_active_tilde_token #2
              \char"#3\relax
            \else
              #2\char"#1\relax
            \fi
          \fi
        \fi
      }
  }

\def\add@UTF@accents#1#2#3{#2\char"#1\char"#3\relax}
\def\add@set@accentCOMP#1#2#3{\add@accent{"#1}{#2}}
\def\add@set@accentMOD#1#2#3{\add@accent{"#3}{#2}}
\def\declare@hex@command#1#2{\gdef#2{#1}}

\def\declare@utf@composite#1#2#3#4
  {
    \expandafter\ifcat\expandafter A\string#4\relax
     {\ifx\add@flag\@ne
      \expandafter\xdef\csname\string#1\string#3-#4\endcsname{#2}
     \else
      \expandafter\global\expandafter
       \let\csname\string#1\string#3-#4\endcsname\relax
     \fi}
    \else
     {\ifx\add@flag\@ne 
      \expandafter\xdef\csname\string#1\string#3-\string#4\endcsname{#2}
     \else
      \expandafter\global\expandafter
       \let\csname\string#1\string#3-\string#4\endcsname\relax
     \fi}
    \fi
  }

% bring \textsuperscript and \textsubscript into the fold of macros 
% dependent on encoding
\let\realLaTeXsuperscript\textsuperscript
\let\realLaTeXsubscript\textsubscript
\DeclareTextAccent{\textsuperscript}{OT1}{999}
\expandafter\expandafter\expandafter\let\expandafter
 \csname?\string\textsuperscript\endcsname\realLaTeXsuperscript
\DeclareTextAccent{\textsubscript}{OT1}{999}
\expandafter\expandafter\expandafter\let\expandafter
 \csname?\string\textsubscript\endcsname\realLaTeXsubscript
\let\super\textsuperscript

\endinput
